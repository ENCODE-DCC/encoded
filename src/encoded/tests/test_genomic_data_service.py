import pytest
import responses


NDJSON_STREAMED_RESPONSE = b'{"@id": "/expressions/ENCFF241WYH/ENSG00000039987.6/", "@type": ["RNAExpression", "Item"], "dataset": {"biosample_summary": "muscle of trunk tissue female embryo (113 days)", "@id": "/experiments/ENCSR906HEV/", "replicates": [{"library": {"biosample": {"donor": {"organism": {"scientific_name": "Homo sapiens"}}, "sex": "female"}}}]}, "expression": {"tpm": 0.01, "fpkm": 0.02, "gene_id": "ENSG00000039987.6"}, "file": {"genome_annotation": "V29", "assay_title": "polyA plus RNA-seq", "biosample_ontology": {"organ_slims": ["musculature of body"], "term_name": "muscle of trunk", "classification": "tissue"}, "assembly": "GRCh38", "donors": ["/human-donors/ENCDO676JUB/"], "@id": "/files/ENCFF241WYH/"}}\n{"@id": "/expressions/ENCFF241WYH/ENSG00000060982.14/", "@type": ["RNAExpression", "Item"], "dataset": {"biosample_summary": "muscle of trunk tissue female embryo (113 days)", "@id": "/experiments/ENCSR906HEV/", "replicates": [{"library": {"biosample": {"donor": {"organism": {"scientific_name": "Homo sapiens"}}, "sex": "female"}}}]}, "expression": {"tpm": 10.18, "fpkm": 15.8, "gene_id": "ENSG00000060982.14"}, "file": {"genome_annotation": "V29", "assay_title": "polyA plus RNA-seq", "biosample_ontology": {"organ_slims": ["musculature of body"], "term_name": "muscle of trunk", "classification": "tissue"}, "assembly": "GRCh38", "donors": ["/human-donors/ENCDO676JUB/"], "@id": "/files/ENCFF241WYH/"}}\n{"@id": "/expressions/ENCFF273KTX/ENSG00000060982.14/", "@type": ["RNAExpression", "Item"], "dataset": {"biosample_summary": "uterus tissue female adult (53 years)", "@id": "/experiments/ENCSR113HQM/", "replicates": [{"library": {"biosample": {"donor": {"organism": {"scientific_name": "Homo sapiens"}}, "sex": "female"}}}]}, "expression": {"tpm": 10.18, "fpkm": 15.8, "gene_id": "ENSG00000060982.14"}, "file": {"genome_annotation": "V29", "assay_title": "total RNA-seq", "biosample_ontology": {"organ_slims": ["uterus"], "term_name": "uterus", "classification": "tissue"}, "assembly": "GRCh38", "donors": ["/human-donors/ENCDO793LXB/"], "@id": "/files/ENCFF273KTX/"}}\n{"@id": "/expressions/ENCFF241WYH/ENSG00000055732.12/", "@type": ["RNAExpression", "Item"], "dataset": {"biosample_summary": "muscle of trunk tissue female embryo (113 days)", "@id": "/experiments/ENCSR906HEV/", "replicates": [{"library": {"biosample": {"donor": {"organism": {"scientific_name": "Homo sapiens"}}, "sex": "female"}}}]}, "expression": {"tpm": 0.27, "fpkm": 0.41, "gene_id": "ENSG00000055732.12"}, "file": {"genome_annotation": "V29", "assay_title": "polyA plus RNA-seq", "biosample_ontology": {"organ_slims": ["musculature of body"], "term_name": "muscle of trunk", "classification": "tissue"}, "assembly": "GRCh38", "donors": ["/human-donors/ENCDO676JUB/"], "@id": "/files/ENCFF241WYH/"}}\n{"@id": "/expressions/ENCFF273KTX/ENSG00000034677.12/", "@type": ["RNAExpression", "Item"], "dataset": {"biosample_summary": "uterus tissue female adult (53 years)", "@id": "/experiments/ENCSR113HQM/", "replicates": [{"library": {"biosample": {"donor": {"organism": {"scientific_name": "Homo sapiens"}}, "sex": "female"}}}]}, "expression": {"tpm": 9.34, "fpkm": 14.49, "gene_id": "ENSG00000034677.12"}, "file": {"genome_annotation": "V29", "assay_title": "total RNA-seq", "biosample_ontology": {"organ_slims": ["uterus"], "term_name": "uterus", "classification": "tissue"}, "assembly": "GRCh38", "donors": ["/human-donors/ENCDO793LXB/"], "@id": "/files/ENCFF273KTX/"}, "gene": {"symbol": "RNF19A", "name": "ring finger protein 19A, RBR E3 ubiquitin protein ligase", "title": "RNF19A (Homo sapiens)"}}\n{"@id": "/expressions/ENCFF106SZG/ENSG00000039987.6/", "@type": ["RNAExpression", "Item"], "dataset": {"biosample_summary": "GM23338 originated from GM23248", "@id": "/experiments/ENCSR938LSP/", "replicates": [{"library": {"biosample": {"donor": {"organism": {"scientific_name": "Homo sapiens"}}, "sex": "male"}}}, {"library": {"biosample": {"donor": {"organism": {"scientific_name": "Homo sapiens"}}, "sex": "male"}}}]}, "expression": {"tpm": 0.01, "fpkm": 0.02, "gene_id": "ENSG00000039987.6"}, "file": {"genome_annotation": "V29", "assay_title": "total RNA-seq", "biosample_ontology": {"organ_slims": ["skin of body"], "term_name": "GM23338", "classification": "cell line"}, "assembly": "GRCh38", "donors": ["/human-donors/ENCDO336AAA/"], "@id": "/files/ENCFF106SZG/"}}\n{"@id": "/expressions/ENCFF106SZG/ENSG00000055732.12/", "@type": ["RNAExpression", "Item"], "dataset": {"biosample_summary": "GM23338 originated from GM23248", "@id": "/experiments/ENCSR938LSP/", "replicates": [{"library": {"biosample": {"donor": {"organism": {"scientific_name": "Homo sapiens"}}, "sex": "male"}}}, {"library": {"biosample": {"donor": {"organism": {"scientific_name": "Homo sapiens"}}, "sex": "male"}}}]}, "expression": {"tpm": 0.27, "fpkm": 0.41, "gene_id": "ENSG00000055732.12"}, "file": {"genome_annotation": "V29", "assay_title": "total RNA-seq", "biosample_ontology": {"organ_slims": ["skin of body"], "term_name": "GM23338", "classification": "cell line"}, "assembly": "GRCh38", "donors": ["/human-donors/ENCDO336AAA/"], "@id": "/files/ENCFF106SZG/"}}\n{"@id": "/expressions/ENCFF730OTJ/ENSG00000034677.12/", "@type": ["RNAExpression", "Item"], "dataset": {"biosample_summary": "GM23338 originated from GM23248", "@id": "/experiments/ENCSR938LSP/", "replicates": [{"library": {"biosample": {"donor": {"organism": {"scientific_name": "Homo sapiens"}}, "sex": "male"}}}, {"library": {"biosample": {"donor": {"organism": {"scientific_name": "Homo sapiens"}}, "sex": "male"}}}]}, "expression": {"tpm": 9.34, "fpkm": 14.49, "gene_id": "ENSG00000034677.12"}, "file": {"genome_annotation": "V29", "assay_title": "total RNA-seq", "biosample_ontology": {"organ_slims": ["skin of body"], "term_name": "GM23338", "classification": "cell line"}, "assembly": "GRCh38", "donors": ["/human-donors/ENCDO336AAA/"], "@id": "/files/ENCFF730OTJ/"}, "gene": {"symbol": "RNF19A", "name": "ring finger protein 19A, RBR E3 ubiquitin protein ligase", "title": "RNF19A (Homo sapiens)"}}\n{"@id": "/expressions/ENCFF730OTJ/ENSG00000055732.12/", "@type": ["RNAExpression", "Item"], "dataset": {"biosample_summary": "GM23338 originated from GM23248", "@id": "/experiments/ENCSR938LSP/", "replicates": [{"library": {"biosample": {"donor": {"organism": {"scientific_name": "Homo sapiens"}}, "sex": "male"}}}, {"library": {"biosample": {"donor": {"organism": {"scientific_name": "Homo sapiens"}}, "sex": "male"}}}]}, "expression": {"tpm": 0.27, "fpkm": 0.41, "gene_id": "ENSG00000055732.12"}, "file": {"genome_annotation": "V29", "assay_title": "total RNA-seq", "biosample_ontology": {"organ_slims": ["skin of body"], "term_name": "GM23338", "classification": "cell line"}, "assembly": "GRCh38", "donors": ["/human-donors/ENCDO336AAA/"], "@id": "/files/ENCFF730OTJ/"}}\n{"@id": "/expressions/ENCFF273KTX/ENSG00000039987.6/", "@type": ["RNAExpression", "Item"], "dataset": {"biosample_summary": "uterus tissue female adult (53 years)", "@id": "/experiments/ENCSR113HQM/", "replicates": [{"library": {"biosample": {"donor": {"organism": {"scientific_name": "Homo sapiens"}}, "sex": "female"}}}]}, "expression": {"tpm": 0.01, "fpkm": 0.02, "gene_id": "ENSG00000039987.6"}, "file": {"genome_annotation": "V29", "assay_title": "total RNA-seq", "biosample_ontology": {"organ_slims": ["uterus"], "term_name": "uterus", "classification": "tissue"}, "assembly": "GRCh38", "donors": ["/human-donors/ENCDO793LXB/"], "@id": "/files/ENCFF273KTX/"}}\n{"@id": "/expressions/ENCFF106SZG/ENSG00000034677.12/", "@type": ["RNAExpression", "Item"], "dataset": {"biosample_summary": "GM23338 originated from GM23248", "@id": "/experiments/ENCSR938LSP/", "replicates": [{"library": {"biosample": {"donor": {"organism": {"scientific_name": "Homo sapiens"}}, "sex": "male"}}}, {"library": {"biosample": {"donor": {"organism": {"scientific_name": "Homo sapiens"}}, "sex": "male"}}}]}, "expression": {"tpm": 9.34, "fpkm": 14.49, "gene_id": "ENSG00000034677.12"}, "file": {"genome_annotation": "V29", "assay_title": "total RNA-seq", "biosample_ontology": {"organ_slims": ["skin of body"], "term_name": "GM23338", "classification": "cell line"}, "assembly": "GRCh38", "donors": ["/human-donors/ENCDO336AAA/"], "@id": "/files/ENCFF106SZG/"}, "gene": {"symbol": "RNF19A", "name": "ring finger protein 19A, RBR E3 ubiquitin protein ligase", "title": "RNF19A (Homo sapiens)"}}\n{"@id": "/expressions/ENCFF730OTJ/ENSG00000060982.14/", "@type": ["RNAExpression", "Item"], "dataset": {"biosample_summary": "GM23338 originated from GM23248", "@id": "/experiments/ENCSR938LSP/", "replicates": [{"library": {"biosample": {"donor": {"organism": {"scientific_name": "Homo sapiens"}}, "sex": "male"}}}, {"library": {"biosample": {"donor": {"organism": {"scientific_name": "Homo sapiens"}}, "sex": "male"}}}]}, "expression": {"tpm": 10.18, "fpkm": 15.8, "gene_id": "ENSG00000060982.14"}, "file": {"genome_annotation": "V29", "assay_title": "total RNA-seq", "biosample_ontology": {"organ_slims": ["skin of body"], "term_name": "GM23338", "classification": "cell line"}, "assembly": "GRCh38", "donors": ["/human-donors/ENCDO336AAA/"], "@id": "/files/ENCFF730OTJ/"}}\n{"@id": "/expressions/ENCFF241WYH/ENSG00000034677.12/", "@type": ["RNAExpression", "Item"], "dataset": {"biosample_summary": "muscle of trunk tissue female embryo (113 days)", "@id": "/experiments/ENCSR906HEV/", "replicates": [{"library": {"biosample": {"donor": {"organism": {"scientific_name": "Homo sapiens"}}, "sex": "female"}}}]}, "expression": {"tpm": 9.34, "fpkm": 14.49, "gene_id": "ENSG00000034677.12"}, "file": {"genome_annotation": "V29", "assay_title": "polyA plus RNA-seq", "biosample_ontology": {"organ_slims": ["musculature of body"], "term_name": "muscle of trunk", "classification": "tissue"}, "assembly": "GRCh38", "donors": ["/human-donors/ENCDO676JUB/"], "@id": "/files/ENCFF241WYH/"}, "gene": {"symbol": "RNF19A", "name": "ring finger protein 19A, RBR E3 ubiquitin protein ligase", "title": "RNF19A (Homo sapiens)"}}\n{"@id": "/expressions/ENCFF273KTX/ENSG00000055732.12/", "@type": ["RNAExpression", "Item"], "dataset": {"biosample_summary": "uterus tissue female adult (53 years)", "@id": "/experiments/ENCSR113HQM/", "replicates": [{"library": {"biosample": {"donor": {"organism": {"scientific_name": "Homo sapiens"}}, "sex": "female"}}}]}, "expression": {"tpm": 0.27, "fpkm": 0.41, "gene_id": "ENSG00000055732.12"}, "file": {"genome_annotation": "V29", "assay_title": "total RNA-seq", "biosample_ontology": {"organ_slims": ["uterus"], "term_name": "uterus", "classification": "tissue"}, "assembly": "GRCh38", "donors": ["/human-donors/ENCDO793LXB/"], "@id": "/files/ENCFF273KTX/"}}\n{"@id": "/expressions/ENCFF106SZG/ENSG00000060982.14/", "@type": ["RNAExpression", "Item"], "dataset": {"biosample_summary": "GM23338 originated from GM23248", "@id": "/experiments/ENCSR938LSP/", "replicates": [{"library": {"biosample": {"donor": {"organism": {"scientific_name": "Homo sapiens"}}, "sex": "male"}}}, {"library": {"biosample": {"donor": {"organism": {"scientific_name": "Homo sapiens"}}, "sex": "male"}}}]}, "expression": {"tpm": 10.18, "fpkm": 15.8, "gene_id": "ENSG00000060982.14"}, "file": {"genome_annotation": "V29", "assay_title": "total RNA-seq", "biosample_ontology": {"organ_slims": ["skin of body"], "term_name": "GM23338", "classification": "cell line"}, "assembly": "GRCh38", "donors": ["/human-donors/ENCDO336AAA/"], "@id": "/files/ENCFF106SZG/"}}\n{"@id": "/expressions/ENCFF730OTJ/ENSG00000039987.6/", "@type": ["RNAExpression", "Item"], "dataset": {"biosample_summary": "GM23338 originated from GM23248", "@id": "/experiments/ENCSR938LSP/", "replicates": [{"library": {"biosample": {"donor": {"organism": {"scientific_name": "Homo sapiens"}}, "sex": "male"}}}, {"library": {"biosample": {"donor": {"organism": {"scientific_name": "Homo sapiens"}}, "sex": "male"}}}]}, "expression": {"tpm": 0.01, "fpkm": 0.02, "gene_id": "ENSG00000039987.6"}, "file": {"genome_annotation": "V29", "assay_title": "total RNA-seq", "biosample_ontology": {"organ_slims": ["skin of body"], "term_name": "GM23338", "classification": "cell line"}, "assembly": "GRCh38", "donors": ["/human-donors/ENCDO336AAA/"], "@id": "/files/ENCFF730OTJ/"}}\n'


@responses.activate
def test_genomic_data_service_parse_ndjson():
    from encoded.genomic_data_service import RNAGET_SEARCH_STREAM_URL
    from encoded.genomic_data_service import remote_stream_get
    from encoded.genomic_data_service import parse_ndjson
    responses.add(
        responses.GET,
        RNAGET_SEARCH_STREAM_URL,
        body=NDJSON_STREAMED_RESPONSE,
        status=200
    )
    results = remote_stream_get(RNAGET_SEARCH_STREAM_URL)
    data = list(parse_ndjson(results))
    assert len(data) == 16
    assert data[0]['@id'] == '/expressions/ENCFF241WYH/ENSG00000039987.6/'


@responses.activate
def test_genomic_data_service_parse_empty_ndjson():
    from encoded.genomic_data_service import RNAGET_SEARCH_STREAM_URL
    from encoded.genomic_data_service import remote_stream_get
    from encoded.genomic_data_service import parse_ndjson
    responses.add(
        responses.GET,
        RNAGET_SEARCH_STREAM_URL,
        body=b'',
        status=404
    )
    results = remote_stream_get(RNAGET_SEARCH_STREAM_URL)
    data = list(parse_ndjson(results))
    assert len(data) == 0
