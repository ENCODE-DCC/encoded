{
    "title": "Analysis step run",
    "description": "Schema for reporting the specific calculation of an analysis_step",
    "id": "/profiles/analysis_step_run.json",
    "$schema": "http://json-schema.org/draft-04/schema#",
    "type": "object",
    "required": ["analysis_step_version", "status"],
    "additionalProperties": false,
    "identifyingProperties": ["uuid"],
    "mixinProperties": [
        {"$ref": "mixins.json#/schema_version"},
        {"$ref": "mixins.json#/aliases"},
        {"$ref": "mixins.json#/uuid" },
        {"$ref": "mixins.json#/submitted"},
        {"$ref": "mixins.json#/notes"},
        {"$ref": "mixins.json#/standard_status"}
    ],
    "properties": {
        "schema_version": {
            "default": "5"
        },
        "analysis_step_version": {
            "title": "Analysis Step Version",
            "description": "Reference to template step in pipeline",
            "type": "string",
            "linkTo": "AnalysisStepVersion"
        },
        "run_id": {
            "title": "Identifier of this step run",
            "type": "string",
            "pattern": "^[0-9-a-zA-Z]+$",
            "permission": "import_items"
        },
        "run_status": {
            "title": "Execution status of this step run",
            "type": "string",
            "permission": "import_items",
            "default": "Submitted",
            "enum" : [
                "Submitted",
                "Failed",
                "Succeeded",
                "Aborted"
            ]
        },
        "analysis": {
            "title": "Analysis",
            "description": "The analysis object the analysis step belongs to.",
            "comment": "Required. See analysis.json for available identifiers.",
            "type": "string",
            "linkTo": "Analysis",
            "permission": "import_items"
        },
        "previous_step_runs": {
            "title": "Previous step run(s)",
            "description": "Step(s) run right before the current step.",
            "type": "array",
            "permission": "import_items",
            "items": {
                "title": "The previous analysis step run",
                "description": "One analysis step run right before the current step",
                "type": "string",
                "linkTo": "AnalysisStepRun"
            }
        },
        "input_files": {
            "title": "Input files",
            "description": "Input files to this analysis step run.",
            "type": "array",
            "permission": "import_items",
            "items": {
                "title": "Input file",
                "comment": "See file.json for available identifiers.",
                "type": "string",
                "linkTo": "File"
            }
        },
        "output_files": {
            "title": "Output files",
            "description": "Output files to this analysis step fun.",
            "type": "array",
            "permission": "import_items",
            "items": {
                "title": "Output file",
                "comment": "See file.json for available identifiers.",
                "type": "string",
                "linkTo": "File"
            }
        },
        "platform": {
            "title": "platform",
            "description": "The platform on which the step run (e.g. JES, SGE, Local).",
            "type": "string",
            "enum": [
                "Local",
                "DNAnexus",
                "AWS",
                "Google Cloud"
            ],
            "permission": "import_items"
        },
        "begin_time": {
            "title": "Analysis begin time",
            "description": "Begin time for the whole analsis.",
            "type": "string",
            "anyOf": [
                {"format": "date-time"},
                {"format": "date"}
            ],
            "permission": "import_items"
        },
        "finish_time": {
            "title": "Analysis finish time",
            "description": "Finish time for the whole analsis.",
            "type": "string",
            "anyOf": [
                {"format": "date-time"},
                {"format": "date"}
            ],
            "permission": "import_items"
        },
        "dx_applet_details": {
            "title": "DNA Nexus applet details",
            "description": "Metadata capture from DNA Nexus applets",
            "type": "array",
            "items": {
                "title": "DNA Nexus applet detail",
                "type": "object",
                "additionalProperties": false,
                "properties": {
                    "dx_job_id": {
                        "title": "DNA Nexus job id",
                        "description": "Identifier in the DNA Nexus system",
                        "type": "string"
                    },
                    "dx_app_json": {
                        "title": "DNA Nexus applet json",
                        "description": "dxapp JSON for the applet (wrapper code) corresponding to the step",
                        "type": "object",
                        "properties": {},
                        "additionalProperties": true
                    },
                    "parameters": {
                        "title": "Input Parameters",
                        "description": "The input parameters used for this run (could be extracted from dx_job)",
                        "type": "object",
                        "properties": {},
                        "additionalProperties": true
                    },
                    "started_running": {
                        "title": "Start time",
                        "description": "When the analysis step was started",
                        "type": "string",
                        "format": "date-time"
                    },
                    "stopped_running": {
                        "title": "Finish time",
                        "description": "When the analysis step ended",
                        "type": "string",
                        "format": "date-time"
                    },
                    "dx_status": {
                        "title": "Status",
                        "type": "string",
                        "default": "waiting",
                        "enum" : [
                            "error",
                            "finished",
                            "running",
                            "waiting"
                        ]
                    }
                }
            }
        }
    },
    "facets": {
        "status": {
            "title": "Status"
        }
    },
    "changelog": "/profiles/changelogs/analysis_step_run.md"

}
